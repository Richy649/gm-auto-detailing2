<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Your account — GM Auto Detailing</title>
  <link rel="stylesheet" href="/calendar.css" />
  <style>
    .acct-wrap { max-width: 820px; margin: 24px auto 40px; }
    .gm.logo { display:block; width:170px; margin: 0 auto 10px; }
    .sub-manage { position:relative; font-size:13px; margin: 6px 0 12px; }
    .sub-manage a { color:#111; text-decoration:none; border:1px solid #ccc; border-radius:999px; padding:6px 10px; }
    .panel-joined { padding: 18px; }
    .section-title { font-weight:700; margin:18px 0 8px; font-size:18px; }
    .row-line { display:flex; justify-content:space-between; padding:8px 0; border-top:1px solid #eee; }
    .row-line:first-of-type { border-top:none; }
    .muted { color:#555; }
    .cap { text-transform:capitalize; }
    .book-item { padding:8px 0; border-top:1px dashed #ddd; }
    .book-item:first-of-type { border-top:none; }
    .empty { color:#666; padding:8px 0; }
  </style>
</head>
<body class="gm">
  <div class="page-section wrap acct-wrap">
    <img class="gm logo" src="/logo.png" alt="GM Auto Detailing" />

    <!-- Smaller "Manage subscription" under the logo, top-left -->
    <div class="sub-manage">
      <a id="manageSubLink" href="#" style="display:none">Manage subscription</a>
    </div>

    <!-- One big joined panel -->
    <div class="panel panel-joined" id="panel">
      <div class="h2" style="margin-bottom:6px">Your account</div>

      <!-- Profile -->
      <div class="section-title">Profile</div>
      <div class="row-line"><div>Name</div><div id="name" class="muted"></div></div>
      <div class="row-line"><div>Email</div><div id="email" class="muted"></div></div>
      <div class="row-line"><div>Phone</div><div id="phone" class="muted"></div></div>
      <div class="row-line"><div>Address</div><div id="addr" class="muted"></div></div>

      <!-- Credits -->
      <div class="section-title">Credits</div>
      <div class="row-line"><div>Exterior</div><div id="c_ext" class="muted"></div></div>
      <div class="row-line"><div>Full</div><div id="c_full" class="muted"></div></div>

      <!-- Active membership (moved to just below Credits) -->
      <div class="section-title">Active membership</div>
      <div id="membershipArea" class="muted">None</div>

      <!-- Upcoming bookings -->
      <div class="section-title" style="margin-top:18px">Upcoming bookings</div>
      <div id="bookings"></div>

      <!-- Actions -->
      <div style="display:flex; gap:10px; margin-top:18px">
        <a class="gm btn" href="/index.html">Book now</a>
        <button class="gm btn" id="logout">Log out</button>
      </div>
    </div>
  </div>

  <script>
    const API_ROOT = "https://gm-auto-detailing2.onrender.com";
    const API = `${API_ROOT}/api`;

    const token = localStorage.getItem("GM_TOKEN") || "";
    if (!token) window.location.href = "/login.html";

    const $ = (s) => document.querySelector(s);

    function setText(id, v) { const el = $(id); if (el) el.textContent = v || ""; }

    async function loadMe() {
      const r = await fetch(`${API}/auth/me`, { headers: { Authorization: `Bearer ${token}` } });
      if (!r.ok) { localStorage.removeItem("GM_TOKEN"); window.location.href="/login.html"; return; }
      const d = await r.json();
      if (!d?.ok) { localStorage.removeItem("GM_TOKEN"); window.location.href="/login.html"; return; }

      const u = d.user || {};
      setText("#name", u.name || "");
      setText("#email", u.email || "");
      setText("#phone", u.phone || "");
      setText("#addr", [u.street, u.postcode].filter(Boolean).join(", "));

      const credits = d.credits || { exterior:0, full:0 };
      setText("#c_ext", String(credits.exterior || 0));
      setText("#c_full", String(credits.full || 0));

      // Membership
      const subs = d.subscriptions || [];
      const live = subs.find(s => ["active","trialing","past_due"].includes(s.status));
      const memEl = $("#membershipArea");
      if (live) {
        const label = live.tier ? (live.tier[0].toUpperCase() + live.tier.slice(1)) : "Membership";
        const next = live.current_period_end ? new Date(live.current_period_end*1000).toLocaleDateString("en-GB") : "";
        memEl.textContent = `${label} — renews ${next}`;
      } else {
        memEl.textContent = "None";
      }

      // Manage subscription link
      const manageLink = $("#manageSubLink");
      if (live) {
        manageLink.style.display = "inline-block";
        manageLink.onclick = async (e) => {
          e.preventDefault();
          const r = await fetch(`${API}/memberships/portal`, { method:"POST", headers:{ Authorization:`Bearer ${token}` } });
          const j = await r.json().catch(()=>({}));
          if (j?.url) window.location.href = j.url;
        };
      }

      // Upcoming bookings
      try {
        const br = await fetch(`${API}/my/bookings`, { headers:{ Authorization:`Bearer ${token}` } });
        const bj = await br.json().catch(()=>({}));
        const list = Array.isArray(bj?.bookings) ? bj.bookings : [];
        const cont = $("#bookings");
        cont.innerHTML = "";
        if (!list.length) {
          const d = document.createElement("div");
          d.className = "empty";
          d.textContent = "No upcoming bookings";
          cont.appendChild(d);
        } else {
          for (const b of list) {
            const row = document.createElement("div");
            row.className = "book-item";
            const when = b.start_iso ? new Date(b.start_iso).toLocaleString("en-GB",{ hour12:false, hour:"2-digit", minute:"2-digit", weekday:"short", day:"numeric", month:"short", year:"numeric" }) : "";
            row.textContent = `${(b.service_key || "").replace("_"," ")} — ${when}`;
            cont.appendChild(row);
          }
        }
      } catch {}
    }

    $("#logout").addEventListener("click", () => {
      localStorage.removeItem("GM_TOKEN");
      window.location.href = "/login.html";
    });

    loadMe();
  </script>
</body>
</html>
