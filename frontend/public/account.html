<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>My Account • GM Auto Detailing</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f3efe8; margin:0; padding:10px; }
      .wrap { max-width:720px; margin:0 auto; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
      .card { background:#fff; border:1px solid #e3e0d7; border-radius:12px; padding:12px; }
      h3 { margin:0 0 8px; font-size:16px; }
      table { width:100%; border-collapse: collapse; }
      td, th { border-bottom:1px solid #eee; padding:6px 4px; font-size:14px; text-align:left; }
      input { width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:8px; }
      button { padding:8px 12px; border-radius:8px; border:0; background:#222; color:#fff; font-weight:700; cursor:pointer; }
      .muted { color:#666; font-size:13px; }
      @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="grid">
        <div class="card">
          <h3>Credits</h3>
          <div class="muted" id="credits">Loading…</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="book">Book now</button>
            <button id="portal" class="light">Manage subscription</button>
          </div>
        </div>
        <div class="card">
          <h3>Your details</h3>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <input id="name" placeholder="Name"/>
            <input id="phone" placeholder="Phone"/>
            <input id="street" placeholder="Street" style="grid-column:1/3;"/>
            <input id="postcode" placeholder="Postcode"/>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="save">Save</button>
            <a href="/reset.html" class="muted">Change / reset password</a>
          </div>
          <div id="status" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <h3>Recent bookings</h3>
        <div class="muted" id="bookings">Loading…</div>
        <table id="tbl" style="display:none;">
          <thead><tr><th>Date</th><th>Service</th><th>Time</th><th>Add-ons</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <script>
      const API = (location.origin.includes('vercel.app') || location.origin.includes('book.'))
        ? 'https://gm-auto-detailing2.onrender.com' : '';
      const token = localStorage.getItem('GM_TOKEN') || "";

      function fmt(dt){ try{ return new Date(dt).toLocaleString('en-GB', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'});}catch{return '';} }

      async function load() {
        if (!token) { document.getElementById('credits').textContent = 'Please login on the booking page.'; return; }
        const me = await fetch(`${API}/api/auth/me`, { headers:{ Authorization:`Bearer ${token}` } }).then(r=>r.json());
        if (!(me.ok && me.user)) { document.getElementById('credits').textContent='Not signed in.'; return; }
        const c = me.credits || { exterior:0, full:0 };
        document.getElementById('credits').textContent = `Exterior: ${c.exterior} • Full: ${c.full}`;
        document.getElementById('name').value = me.user.name || '';
        document.getElementById('phone').value = me.user.phone || '';
        document.getElementById('street').value = me.user.street || '';
        document.getElementById('postcode').value = me.user.postcode || '';

        const bk = await fetch(`${API}/api/my/bookings`, { headers:{ Authorization:`Bearer ${token}` } }).then(r=>r.json());
        const list = bk.rows || [];
        if (!list.length){ document.getElementById('bookings').textContent = 'No bookings yet.'; }
        else {
          document.getElementById('bookings').style.display = 'none';
          document.getElementById('tbl').style.display = '';
          const tb = document.getElementById('rows'); tb.innerHTML='';
          for (const b of list){
            const tr = document.createElement('tr');
            const d = b.start_time || b.end_time || b.created_at;
            const service = (b.service_key === 'full' ? 'Full Detail' :
                             b.service_key === 'exterior' ? 'Exterior Detail' : b.service_key);
            const start = b.start_time ? fmt(b.start_time) : '';
            const end   = b.end_time ? fmt(b.end_time) : '';
            const t = (start && end) ? `${start} - ${end}` : start || '';
            const addons = Array.isArray(b.addons) ? b.addons.join(', ') : '';
            tr.innerHTML = `<td>${new Date(d).toLocaleDateString('en-GB')}</td><td>${service}</td><td>${t}</td><td>${addons}</td>`;
            tb.appendChild(tr);
          }
        }
      }

      document.getElementById('save').onclick = async ()=>{
        const payload = {
          name: document.getElementById('name').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          street: document.getElementById('street').value.trim(),
          postcode: document.getElementById('postcode').value.trim(),
        };
        const r = await fetch(`${API}/api/auth/profile`, {
          method:'POST', headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`},
          body: JSON.stringify(payload)
        });
        const d = await r.json();
        document.getElementById('status').textContent = d.ok ? 'Saved.' : (d.error || 'Save failed');
      };

      document.getElementById('book').onclick = ()=> { location.href = '/?afterLogin=1'; };

      document.getElementById('portal').onclick = async ()=>{
        const r = await fetch(`${API}/api/memberships/portal`, {
          headers:{ Authorization:`Bearer ${token}` }
        });
        const d = await r.json();
        if (d.ok && d.url) location.href = d.url; else alert(d.error || 'Unable to open portal');
      };

      load();
    </script>
  </body>
</html>
