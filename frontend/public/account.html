<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Your Account • GM Auto Detailing</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg:#faf8f5;          /* beige page background */
        --card:#ffffff;        /* white card */
        --border:#e6e1d8;
        --text:#1c1c1c;
        --muted:#6e6e6e;
        --accent:#222;
        --success:#23a35a;

        --radius:22px;
        --shadow-1:0 2px 10px rgba(0,0,0,.06);
        --shadow-2:0 6px 22px rgba(0,0,0,.08);

        --fs-sm:14px;
        --fs-md:16px;
        --fs-lg:clamp(20px,2.6vw,28px);
      }
      *{ box-sizing:border-box; }
      body{
        margin:0; padding:20px;
        font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        color:var(--text); background:var(--bg);
      }
      .container{ max-width:980px; margin:0 auto; }

      /* CARD */
      .card{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:var(--radius);
        box-shadow:var(--shadow-1);
        padding:20px;
      }

      /* HEADER ROW */
      .profile-row{
        display:grid;
        grid-template-columns: 120px 1fr;
        gap:16px;
        align-items:center;
      }
      .avatar{
        width:120px; height:120px; border-radius:50%;
        background:#f1f1f1; border:1px solid var(--border);
        display:flex; align-items:center; justify-content:center;
        overflow:hidden; user-select:none;
      }
      .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
      .avatar .initials{
        font-weight:800; font-size:40px; color:#333;
      }

      .profile-meta .name{
        font-weight:800; font-size:var(--fs-lg); line-height:1.1;
      }
      .profile-meta .addr{
        margin-top:6px; color:var(--muted); font-weight:600;
      }
      .profile-meta .mini{
        margin-top:6px; color:#444; font-size:var(--fs-sm);
      }

      /* CREDITS ROW */
      .credits-row{
        margin:18px 0 8px;
        display:grid; grid-template-columns: 1fr 1fr;
        gap:0; align-items:center;
      }
      .credit-box{
        text-align:center; padding:16px 10px;
      }
      .credit-divider{
        width:1px; height:44px; background:linear-gradient(180deg,transparent,#e9e6de,transparent);
        margin:0 auto;
      }
      .credit-label{
        color:var(--muted); font-size:13px; font-weight:700; letter-spacing:.3px; text-transform:uppercase;
      }
      .credit-value{
        margin-top:6px; font-weight:800; font-size:24px;
      }
      .credit-value.positive{ color:#0b6b37; }

      /* SECTION TITLE */
      .section-title{
        margin:16px 0 10px; font-weight:800; font-size:20px;
      }
      /* ACTION TILES */
      .tiles{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
      .tile{
        border:1px solid var(--border);
        border-radius:16px; background:#fff;
        padding:14px; display:flex; align-items:center; gap:10px;
        cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,.04);
        transition:box-shadow .16s, transform .12s;
      }
      .tile:hover{ box-shadow:var(--shadow-2); transform:translateY(-1px); }
      .tile:active{ transform:translateY(0); }
      .tile .ico{ width:22px; height:22px; }
      .tile .label{ font-weight:800; }

      /* FOOTER ACTIONS */
      .footer-actions{
        margin-top:12px; display:flex; gap:12px; align-items:center;
      }
      .btn-text{
        background:none; border:none; color:#111; font-weight:700; font-size:16px;
        padding:8px 4px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;
      }
      .btn-text:hover{ color:#444; }

      /* RESPONSIVE */
      @media (max-width:760px){
        .profile-row{ grid-template-columns: 1fr; text-align:center; }
        .avatar{ margin:0 auto; }
        .credits-row{ grid-template-columns:1fr 1px 1fr; }
        .credit-divider{ height:36px; }
        .tiles{ grid-template-columns:1fr; }
        .footer-actions{ justify-content:center; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- SINGLE WHITE CARD -->
      <div class="card">

        <!-- Header: Avatar + Name/Address -->
        <div class="profile-row">
          <div class="avatar" id="avatar">
            <!-- JS will replace with <img> or initials -->
            <div class="initials" id="initials">GM</div>
          </div>

          <div class="profile-meta">
            <div class="name" id="name">Loading…</div>
            <div class="addr" id="addr">—</div>
            <div class="mini" id="mini">—</div>
          </div>
        </div>

        <!-- Credits row -->
        <div class="credits-row" aria-label="Membership credits">
          <div class="credit-box">
            <div class="credit-label">Exterior credits</div>
            <div class="credit-value" id="extCredits">0</div>
          </div>
          <div class="credit-divider" role="presentation"></div>
          <div class="credit-box">
            <div class="credit-label">Full credits</div>
            <div class="credit-value" id="fullCredits">0</div>
          </div>
        </div>

        <!-- Info tiles -->
        <div class="section-title">Info</div>
        <div class="tiles">
          <button class="tile" id="goBookings" aria-label="View bookings">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span class="label">View bookings</span>
          </button>

          <button class="tile" id="goDetails" aria-label="Your details">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="label">Details</span>
          </button>

          <button class="tile" id="goPortal" aria-label="Manage subscription">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="2" y="5" width="20" height="14" rx="2" ry="2"></rect>
              <line x1="2" y1="10" x2="22" y2="10"></line>
            </svg>
            <span class="label">Manage subscription</span>
          </button>
        </div>

        <!-- Footer actions (optional) -->
        <div class="footer-actions">
          <button id="signout" class="btn-text">Sign out</button>
        </div>
      </div>
    </div>

    <script>
      /* ===== height to parent (iframe) ===== */
      function reportHeight(){
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight, window.innerHeight);
        try { window.parent.postMessage({ type:"GM_HEIGHT", height:h }, "*"); } catch {}
      }
      window.addEventListener("load", reportHeight);
      window.addEventListener("resize", () => setTimeout(reportHeight, 60));
      setInterval(reportHeight, 900);

      /* ===== API roots (same heuristic as your other pages) ===== */
      const API = (location.origin.includes('vercel.app') || location.origin.includes('book.'))
        ? 'https://gm-auto-detailing2.onrender.com' : '';

      const token = localStorage.getItem('GM_TOKEN') || "";
      if (!token) location.href = "/login.html";

      const $ = (id)=> document.getElementById(id);

      /* Avatar helpers: initials fallback */
      function initialsFrom(nameOrEmail){
        if (!nameOrEmail) return "GM";
        const s = nameOrEmail.trim();
        if (s.includes(" ")) {
          const [a,b] = s.split(" ");
          return (a[0] + (b?.[0] || "")).toUpperCase();
        }
        if (s.includes("@")) return s[0].toUpperCase();
        return (s[0] + (s[1]||"")).toUpperCase();
      }

      async function loadProfile(){
        try {
          const r = await fetch(`${API}/api/auth/me`, { headers: { Authorization:`Bearer ${token}` } });
          if (!r.ok) throw new Error("auth");
          const d = await r.json();

          const user = d.user || {};
          const name = user.name || (user.email ? user.email.split("@")[0] : "Customer");
          const addr = [user.street, user.postcode].filter(Boolean).join(", ");
          const mini = [user.phone, user.email].filter(Boolean).join(" • ");

          $("name").textContent = name;
          $("addr").textContent = addr || "Address not set";
          $("mini").textContent = mini || "";

          /* avatar: if you later add user.photo, set <img src="..."> */
          const avatarBox = $("avatar");
          avatarBox.innerHTML = "";
          const init = document.createElement("div");
          init.className = "initials";
          init.textContent = initialsFrom(user.name || user.email || "GM");
          avatarBox.appendChild(init);

          /* credits */
          const ext = (d.credits?.exterior || 0);
          const full = (d.credits?.full || 0);
          $("extCredits").textContent = ext;
          $("fullCredits").textContent = full;
          if (ext > 0) $("extCredits").classList.add("positive");
          if (full > 0) $("fullCredits").classList.add("positive");

        } catch {
          localStorage.removeItem('GM_TOKEN');
          location.href = "/login.html";
        } finally {
          setTimeout(reportHeight, 60);
        }
      }

      /* tile actions */
      $("goBookings").onclick = () => { location.href = "/bookings.html"; }; // simple separate page (you can add later)
      $("goDetails").onclick  = () => { location.href = "/details.html"; };  // simple separate page (reuse your existing form)
      $("goPortal").onclick   = async () => {
        try {
          const rr = await fetch(`${API}/api/memberships/portal`, { headers: { Authorization:`Bearer ${token}` } });
          const pd = await rr.json().catch(()=> ({}));
          if (pd?.ok && pd?.url) {
            try { window.top.location.href = pd.url; } catch { location.href = pd.url; }
          } else {
            alert("We couldn’t open your subscription portal. Please try again in a moment.");
          }
        } catch {
          alert("Network error opening the subscription portal.");
        }
      };

      $("signout").onclick = () => {
        localStorage.removeItem('GM_TOKEN');
        location.href = "/login.html";
      };

      loadProfile();
    </script>
  </body>
</html>
